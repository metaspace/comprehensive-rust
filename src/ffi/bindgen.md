
# Generating External Declarations

* Instead of hand writing the external type definitions, we can use [`bindgen`](https://github.com/rust-lang/rust-bindgen) to do the work for us.
* We can use a cargo [build script](https://doc.rust-lang.org/cargo/reference/build-scripts.html) to call `bindgen`

Place a file called `build.rs` in the crate root with the following content:

```rust,ignore
use std::error::Error;

fn main() -> Result<(), Box<dyn Error>> {

    let flags = vec![String::from("-I/usr/include")];

    // Generate bindings for snappy
    let bindings = bindgen::Builder::default()
        .header("/usr/include/snappy-c.h")
        .allowlist_function("snappy_.*")
        .allowlist_type("snappy_.*")
        .clang_args(flags)
        .generate()
        .expect("Failed to generate bindings");

    // Write bindings to file
    let out_path = std::path::PathBuf::from(std::env::var("OUT_DIR")?);

    bindings
        .write_to_file(out_path.join("bindings.rs"))
        .expect("Failed to write bindings to file");

    // Tell cargo to link snappy
    println!("cargo:rustc-link-lib=snappy");

    Ok(())
}
```

This tells cargo to link `snappy` and generates this output:

```rust
/* automatically generated by rust-bindgen 0.63.0 */

pub const snappy_status_SNAPPY_OK: snappy_status = 0;
pub const snappy_status_SNAPPY_INVALID_INPUT: snappy_status = 1;
pub const snappy_status_SNAPPY_BUFFER_TOO_SMALL: snappy_status = 2;
pub type snappy_status = ::std::os::raw::c_uint;
extern "C" {
    pub fn snappy_compress(
        input: *const ::std::os::raw::c_char,
        input_length: usize,
        compressed: *mut ::std::os::raw::c_char,
        compressed_length: *mut usize,
    ) -> snappy_status;
}
extern "C" {
    pub fn snappy_uncompress(
        compressed: *const ::std::os::raw::c_char,
        compressed_length: usize,
        uncompressed: *mut ::std::os::raw::c_char,
        uncompressed_length: *mut usize,
    ) -> snappy_status;
}
extern "C" {
    pub fn snappy_max_compressed_length(source_length: usize) -> usize;
}
extern "C" {
    pub fn snappy_uncompressed_length(
        compressed: *const ::std::os::raw::c_char,
        compressed_length: usize,
        result: *mut usize,
    ) -> snappy_status;
}
extern "C" {
    pub fn snappy_validate_compressed_buffer(
        compressed: *const ::std::os::raw::c_char,
        compressed_length: usize,
    ) -> snappy_status;
}
```

We can now change our example:

```rust,ignore
mod snappy_sys {
    #![allow(non_upper_case_globals)]
    #![allow(non_camel_case_types)]
    #![allow(non_snake_case)]
    #![allow(dead_code)]

    include!(concat!(env!("OUT_DIR"), "/bindings.rs"));
}

fn main() {
    let x = unsafe { snappy_sys::snappy_max_compressed_length(100) };
    println!("max compressed length of a 100 byte buffer: {}", x);
}
```

<details>

 * [`pkg-config-rs`](https://github.com/rust-lang/pkg-config-rs) allows location of dependencies with pkg-config
 * [`system-deps`](https://github.com/gdesmott/system-deps) allow declaration of pkg-config dependencies in `Cargo.toml`

</details>
